{% load i18n static crispy_forms_tags %}
<!DOCTYPE html>
<html>
<head>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>{% block title %}Mapper{% endblock %}</title>

    <link rel="icon" type="image/png" href="{% static 'favicon.png' %}" />

    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Pacifico&display=swap" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <!--link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" /-->
    <link rel="stylesheet" href="https://bootswatch.com/4/yeti/bootstrap.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css" integrity="sha512-3q8fi8M0VS+X/3n64Ndpp6Bit7oXSiyCnzmlx6IDBLGlY5euFySyJ46RUlqIVs0DPCGOypqP8IRk/EyPvU28mQ==" crossorigin="anonymous" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js" integrity="sha512-f0VlzJbcEB6KiW8ZVtL+5HWPDyW1+nJEjguZ5IVnSQkvZbwBt2RfCBY0CBO1PsMAqxxrG4Di6TfsCPP3ZRwKpA==" crossorigin="anonymous"></script>

	<style>
		.wrapper {
			display: flex;
			height: 100%;
			width: 100%;
			align-items: stretch;
		}
		#filterSidebar {
			min-width: 250px;
			max-width: 250px;
			height: 100%;
		}
		#filterSidebar.active {
			margin-left: -250px;
		}
		#editSidebar {
			min-width: 250px;
			max-width: 250px;
			height: 100%;
		}
		#editSidebar.active {
			margin-left: -250px;
		}
</style>

    {% block head %}
    {% endblock %}

</head>


<body>

{% block navbar %}

	<nav class="navbar navbar-expand-lg navbar-light bg-light">
		<div class="container">

			<a class="navbar-brand" data-toggle="modal" data-target="#confirmStartOver"
			   href="{% if workshop %}{% url 'mapper_index_workshop' workshop_slug=workshop.slug %}{% else %}{% url 'mapper_index' %}{% endif %}">
				{% trans "Stakeholder Mapper" %}
				{% if workshop %}
				- {{ workshop.name }}
				{% endif %}
			</a>

			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTopSupportedContent">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navbarTopSupportedContent">

				<ul class="navbar-nav mr-auto">
				</ul>

			</div>

		</div>
	</nav>

	<nav class="navbar navbar-expand-lg fixed-bottom navbar-light bg-light">
		<div class="container">

			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navbarSupportedContent">

				<ul class="navbar-nav {% if not show_menu %}d-none{% endif %}" id="bottomMenu">
					<li class="nav-item dropup">
						<a class="nav-link dropdown-toggle" href="#" id="newDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						  {% trans "Manage" %}
						</a>
						<div class="dropdown-menu" aria-labelledby="newDropdown">
							<a class="dropdown-item" href="#" data-toggle="modal" data-target="#">
								{% trans "Extend your map" %}
							</a>
							<div class="dropdown-divider"></div>
							<a class="dropdown-item" data-toggle="modal" data-target="#confirmStartOver">
								{% trans "Start over" %}
							</a>
						</div>
					</li>
					<li class="nav-item dropup">
						<a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						  {% trans "View" %}
						</a>
						<div class="dropdown-menu" aria-labelledby="newDropdown">
							<a class="dropdown-item" href="{% url 'mapper_ring' %}">
								{% trans "Interaction circles" %}
							</a>
							<a class="dropdown-item" href="{% url 'mapper_venn' %}">
								{% trans "Venn diagram" %}
							</a>
						</div>
					</li>
					<li class="nav-item dropup">
						<a class="nav-link dropdown-toggle" href="#" id="saveDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							{% trans "Save" %}
						</a>
						<div class="dropdown-menu" aria-labelledby="saveDropdown">
							<a class="dropdown-item" href="#" id="exportJSON" download="network.json">
								{% trans "Data (JSON)" %}
							</a>
							<a class="dropdown-item" href="#" id="exportPNG" download="network.png">
								{% trans "Image (PNG)" %}
							</a>
						</div>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="{% url 'mapper_add' %}">
							{% trans "Add stakeholder" %}
						</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="{% url 'mapper_suggest' %}">
							{% trans "View suggestions" %}
						</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" id="filterSidebarCollapse" href="#">
							{% trans "Filter" %}
						</a>
					</li>
				</ul>

				<ul class="navbar-nav ml-auto" id="ulGroups">
					{% if next_page %}
						<a href="{% if workshop %}{% url 'mapper_page_workshop' workshop_slug=workshop.slug page_no=next_page %}{% else %}{% url 'mapper_page' page_no=next_page %}{% endif %}" class="btn btn-primary" id="btnNext">
							Continue
						</a>
					{% elif modal and not terms_ok %}
						<a href="#" class="btn btn-primary" id="btnModal" data-toggle="modal" data-target="#{{ modal }}">
							Data & privacy
						</a>
					{% endif %}
				</ul>

			</div>

		</div>
	</nav>

{% endblock %}


<div class="wrapper h-100">

	<div id="filterSidebar" class="collapse bg-light h-100 p-2 sidebar">

		{% include 'mapper/filter_form.html' %}

	</div>


	{% if stakeholder_form %}
	<div id="editSidebar" class="collapse bg-light h-100 p-2 sidebar">
		<form id="nodeUpdateForm">

			<h4>
				Update stakeholder information
			</h4>

			<form method="post" id="formStakeholderUpdate">
				{% csrf_token %}
				{{ stakeholder_form|crispy }}
				<button type="submit" class="btn btn-primary w-100">
					Update map
				</button>
			</form>

		</form>
	</div>
	{% endif %}


	<div class="container mt-4">

	{% block content %}
	{% endblock %}

	</div>

</div>


<br>
<br>
<br>
<br>


<div class="modal" tabindex="-1" role="dialog" id="modalTerms">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agree with the privacy terms</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>
			You can download this map as an image (png), or as a json file to continue working on it later.
		</p>
		<p>
			No identifiable data will be shared or published. <a href="#">Read more</a> about how we protect your data.
		</p>
		<p>
			<input type="checkbox" id="checkTermsOK">
			<label for="checkTermsOK">
				I give permission for the data to be used for research purposes.
			</label>
		</p>
      </div>
      <div class="modal-footer">
        <a href="#" type="button" class="btn btn-primary disabled" id="exportJSONModal" download="network.json">Download data</a>
      </div>
    </div>
  </div>
</div>


<div class="modal" tabindex="-1" role="dialog" id="modalSave">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agree with the privacy terms</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>
			You can download this map as an image (png), or as a data (json) file to continue working on it later.
		</p>
		<p>
			Please agree with the <a href="#">data usage terms</a> and give permission for the data to be used for research purposes.
		</p>
		<p>
			No identifiable data will be shared or published. <a href="#">Read more</a> about how we protect your data.
		</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">I don't agree</button>
        <button type="button" class="btn btn-primary" id="btnTermsOK">I agree</button>
      </div>
    </div>
  </div>
</div>


<div class="modal" tabindex="-1" role="dialog" id="confirmStartOver">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Are you sure you want to start over?</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>
			This will erase all your data.
		</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <a href="{% if workshop %}{% url 'mapper_page_workshop' workshop_slug=workshop.slug page_no=1 %}{% else %}{% url 'mapper_page' page_no=1 %}{% endif %}"
		   class="btn btn-primary" id="btnConfirmStartOver">Yes, start over!</a>
      </div>
    </div>
  </div>
</div>


{% block js %}
{% endblock %}


<script>

$(document).ready(function() {

	var stakeholders = {{ stakeholders|safe }};

	$('#filterForm').submit(function(e) {
		e.preventDefault();

		$.get('{% url "mapper_filter" %}?' + $(this).serialize(), function(data) {
			console.log(data);
		});

	});


    $('#filterSidebarCollapse').on('click', function () {
        $('#filterSidebar').toggleClass('collapse');
    });


	var termsOK = {{ terms_ok|lower }};

	function mapSave() {
		$.post('{% url "mapper_save" %}', function(data) {
			console.log(data);
		});
	};

	$('#btnSave').click(function() {
		if (termsOK) {
			mapSave();
		} else {
			$('#modalSave').modal('show');
		}
	});

	function approveTerms() {
		$.post('{% url "mapper_approve_terms" %}', function(data) {
			termsOK = true;
			$('#modalSave').modal('hide');
		});
	};

	$('#btnTermsOK').click(function() {
		approveTerms();
	});

	$('#saveDropdown').on('click', function (e) {
		if (!termsOK) {
			e.preventDefault();
			$('#saveDropdown').dropdown('toggle');
			$('#modalSave').modal('show');
		} else {
			mapSave();
		}
	})

	$('#checkTermsOK').change(function() {
		if (this.checked) {
			approveTerms();
			$('#exportJSONModal').removeClass('disabled');
		} else {
			$('#exportJSONModal').addClass('disabled');
		}
	});


	var $exportPNG = $('#exportPNG');

	if ((typeof s) == 'undefined') {
		$exportPNG.addClass('disabled');
	};


    $exportPNG.click(function() {
		var src_base64 = s.renderers[0].snapshot({format: 'png', labels: true});
		$exportPNG.attr('href', src_base64);
    });


	function downloadJSON($el) {
		var data = btoa(
			JSON.stringify({
				name: '{{ map.name }}',
				stakeholders: stakeholders
			})
		);
        $el.attr('href', 'data:text/json;base64,' + data);
	};

    $('#exportJSON').click(function() {
    	downloadJSON($(this));
    });

    $('#exportJSONModal').click(function() {
    	downloadJSON($(this));
    	$('#btnModal').hide();
    });


	{% if stakeholder_form %}

	// edit nodes

	s.bind('clickNode', function(e) {
		var $form = $('#nodeUpdateForm');

		var node = e.data.node;

		if (node.id == 0) return;

		$('#filterSidebar').collapse('hide');

        $('#editSidebar').collapse('show');

		var name = node.label.trim();
		var stakeholder = stakeholders[name];

		console.log(stakeholder);

		$form.find('input[type=checkbox]').prop('checked', false);

		$form.find('[name=name]').val(name);
		if ('similarities' in stakeholder) {
			$form.find('[name=values]').prop('checked', stakeholder.similarities.indexOf('values') >= 0);
			$form.find('[name=working]').prop('checked', stakeholder.similarities.indexOf('working') >= 0);
			$form.find('[name=resources]').prop('checked', stakeholder.similarities.indexOf('resources') >= 0);

			var similarities = ['values', 'working', 'resources'];
			var custom_similarity = stakeholder.similarities.filter(function(s) { return similarities.indexOf(s) === -1 });
			if (custom_similarity.length > 0) {
				$form.find('[name=extra]').val(custom_similarity[0]);
			}
		}

		$form.find('[name=interact]').val(stakeholder.interact);
		$form.find('[name=collaborate]').val(stakeholder.collaborate);

		s.refresh();
	});

	$(document).click(function(event) {
		var $target = $(event.target);
		if(!$target.closest('#editSidebar').length && $('#editSidebar').is(":visible")) {
			$('#editSidebar').collapse('hide');
		}
	});

	$('#nodeUpdateForm').submit(function(e) {
		e.preventDefault();

		//data = JSON.stringify($(this).serializeArray());
		data = $(this).serialize();

		console.log(data);

		$.ajax({
			type: 'POST',
			url: '{% url "mapper_node_update" %}',
			data: data,
			dataType: 'json',
			success: function(data) {
				window.location.reload();
			}
		});
	});

	{% endif %}

});

</script>

</body>
</html>
