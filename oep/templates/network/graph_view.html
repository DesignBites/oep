{% extends 'base.html' %}
{% load i18n static crispy_forms_tags %}


{% block head %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/sigma.min.js" integrity="sha512-4+XX9O3GEcpTWGNW7m3w/ORF91L4zUX01/U3wAoWIXp1P+LRBEqutZdQIFUeHSa0cJRZ9LPM+GOWus8h8TlYhg==" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.plugins.animate.min.js" integrity="sha512-WxjvX/yh2SfCPUnVmZkn4MYkF/jw8GKtEjFu2+P28bcqdYYsT6feJuaaQyBw7+KWfs87Ol4jb7jB+8qep+cocg==" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.plugins.dragNodes.min.js" integrity="sha512-w9i2zoWU7Te0i+TJoKMyBjHYAptYykPieNa0iT6/ofVbUHvqIhh6f4YVkXV84kAuGbIS+CqvSV/6AHTVt8bUrA==" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.layout.noverlap.min.js" integrity="sha512-U0UOV2CPSrFlOxjSnHr6GMKsRjQIYmarSCgVp9R6FAcby2gLNPgQtGLXylELTBDLbS/R5g1vj5CFS4mLDdDfxQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.parsers.json.min.js" integrity="sha512-uhhcXJvqfQpnVqJRyCs49Ddt16zZ35qFokRiVOZei14sbMdMS9vtubrb1QQvGJ/zQhQbCttBvVJqqiZHrsHo1g==" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.layout.forceAtlas2.min.js" integrity="sha512-RuRd3WCUb6GCaiaEJ2UDkaVblIVAHJNLaDG6Df2OWpzg4kQurQqh/GC/a3eFSopnRiNrwePMFvI13pbYZ1WnAw==" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.renderers.edgeLabels.min.js" integrity="sha512-NdmXr+AEuaizDckUjMI05kDsdoXbj6Z0fDxqAqPfhecHITSzGWPA/zeE/ousxA4pVIALj0V6/JgfTGYT9aS7Jw==" crossorigin="anonymous"></script>

{% endblock %}


{% block navbar %}

	<nav class="navbar navbar-expand-lg fixed-bottom navbar-light bg-light">
		<div class="container">

			<a class="navbar-brand" href="#">
				OEP Stakeholders
			</a>

			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navbarSupportedContent">

				<ul class="navbar-nav mr-auto">
					{% for name, first_relation in group_first_relation %}
					<li class="nav-item group-tab">
						<a class="nav-link" href="#{{ name }}" data-toggle="modal" data-target="#modalAddEntity-{{ first_relation }}">
							<span class="badge badge-pill badge-secondary tab-pill">{{ forloop.counter }}</span>
							{{ name }}
						</a>
					</li>
					{% endfor %}
				</ul>

				<ul class="navbar-nav mr-auto">
					<li class="nav-item dropup">
						<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						  {% trans "More" %}
						</a>
						<div class="dropdown-menu" aria-labelledby="navbarDropdown">
							<a class="dropdown-item" href="#" data-toggle="modal" data-target="#modalAddEntity">
								{% trans "Add a stakeholder" %}
							</a>
							<a class="dropdown-item" href="#" data-toggle="modal" data-target="#modalAddRelation">
								{% trans "Add a relation" %}
							</a>
							<div class="dropdown-divider"></div>
							<a class="dropdown-item" href="">
								{% trans "Filter" %}
							</a>
							<div class="dropdown-divider"></div>
							<a class="dropdown-item" href="">
								{% trans "Export" %}
							</a>
							<a class="dropdown-item" href="">
								{% trans "Import" %}
							</a>
						</div>
					</li>
				</ul>

			</div>

		</div>
	</nav>

{% endblock %}


{% block content %}

	<div class="container">

	    <div id="canvas" class="w-100 m-4" style="height: 400px"></div>

	</div>


<div class="modal fade" id="modalAddEntity" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">
			{% trans "Add a new stakeholder" %}
		</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">

		  <form id="formAddNode">
			  {{ add_node_form|crispy }}
		  </form>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Close" %}</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal" id="btnAddNode" >
			{% trans "Add entity" %}
		</button>
      </div>
    </div>
  </div>
</div>



<div class="modal fade" id="modalInitial" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">

			<div class="modal-header">
				<h5 class="modal-title">
					{% trans "Welcome to the Stakeholder Mapper" %}
				</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>

			<div class="modal-body">

				<p>
					{% trans "To support you in identifying and selecting potential collaborators, letâ€™s start by getting to know you." %}
				</p>

				<form id="formMap">
					{{ map_form|crispy }}
				</form>

			</div>

			<div class="modal-footer">

				{% if not forloop.last %}

				<button type="button" class="btn btn-primary" id="btnSaveMap"
					data-toggle="modal" data-target="#modalAddEntity-{{ relation_type.group_next.id }}" data-dismiss="modal">
					{% trans "Next" %}
				</button>

				{% else %}

				<button type="button" class="btn btn-secondary" data-dismiss="modal">
					{% trans "Close" %}
				</button>

				{% endif %}
			</div>
		</div>
	</div>
</div>



{% for group_name, relation_types in relation_types_grouped.items %}

	{% for relation_type in relation_types.values %}

		<div class="modal {% if forloop.first %}fade{% endif %}" id="modalAddEntity-{{ relation_type.id }}" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">

					<div class="modal-header">
						<h5 class="modal-title">
							{% blocktrans %}{{ group_name }} stakeholders{% endblocktrans %}
						</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>

					<div class="modal-body">

						<h6>
							{{ relation_type.question }}
						</h6>

						{% if relation_type.description %}
						<p>
							{{ relation_type.description }}
						</p>
						{% endif %}

						<form id="formAddGroupNode">
							<input type="hidden" name="add_to" value="0">
							<input type="hidden" name="relation_type" value="{{ relation_type.id }}">
							{{ add_stakeholder_form|crispy }}
						</form>

					</div>

					<div class="modal-footer">

						{% if not forloop.last %}

						<button type="button" class="btn btn-primary" id="btnAddGroupNode"
							data-toggle="modal" data-target="#modalAddEntity-{{ relation_type.group_next.id }}" data-dismiss="modal">
							{% trans "Next" %}
						</button>

						{% else %}

						<button type="button" class="btn btn-secondary" data-dismiss="modal">
							{% trans "Close" %}
						</button>

						{% endif %}
					</div>
				</div>
			</div>
		</div>

	{% endfor %}

{% endfor %}


{% endblock %}


{% block js %}

<script>

	$(window).on('hashchange', function( e ) {
		console.log(window.location.hash);
		var $pill = $('a[href="' + window.location.hash + '"]').find('span');
		$('.tab-pill').removeClass('badge-info').addClass('badge-secondary');
		$pill.removeClass('badge-secondary').addClass('badge-info');
	} );

	var relation_types = {{ relation_types_flat|safe }};

	function layoutOptimize(s) {
		//Start the ForceAtlas2 algorithm to optimize network layout
		s.startForceAtlas2({worker: false, barnesHutOptimize: false, slowDown: 1000, iterationsPerRender: 1000});
		//Set time interval to allow layout algorithm to converge on a good state
		var t = 0;
		var interval = setInterval(function() {
			t += 1;
			if (t >= 5) {
				clearInterval(interval);
				s.stopForceAtlas2();
			}
		}, 100);
	}

    var s = new sigma({
    	renderer: {
    		container: 'canvas',
    		type: 'canvas'
    	},
		settings: {
			minNodeSize: 1,
			maxNodeSize: 10,
			minEdgeSize: 1,
			maxEdgeSize: 10,
			edgeLabelSize: 'proportional'
		}
    });

    var listener = s.configNoverlap({});
	s.startNoverlap();

    let dragListener = sigma.plugins.dragNodes(s, s.renderers[0])

    var i = 0;

    s.graph.addNode({
      // Main attributes:
      id: i,
      label: '{% trans "You" %}',
      // Display attributes:
      x: 10,
      y: 10,
      size: 2,
      color: '#f00'
    })
	s.refresh();
	i += 1;

    $('#btnAddNode').click(function () {
		s.graph.addNode({
		  id: i,
		  label: $('#id_name').val(),
		  x: Math.floor(400 * Math.random()),
		  y: Math.floor(400 * Math.random()),
		  size: $('#id_size').val(),
		  color: relation_types[$('#id_relation_type').val()].color
		}).addEdge({
		  id: 'e' + i,
		  source: $('#id_add_to option:checked').val(),
		  target: i,
		  size: $('#id_weight').val(),
		  label: relation_types[$('#id_relation_type').val()].name,
		  color: relation_types[$('#id_relation_type').val()].color
		});
		$('#id_add_to').append($('<option>', {
			value: i,
			text: $('#id_name').val()
		}));
		i += 1;
	    s.refresh();
	    layoutOptimize(s);
	    console.log({ nodes: s.graph.nodes(), edges: s.graph.edges() });
    });


</script>

{% endblock %}