{% extends 'base.html' %}
{% load i18n static crispy_forms_tags %}


{% block head %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/sigma.min.js" integrity="sha512-4+XX9O3GEcpTWGNW7m3w/ORF91L4zUX01/U3wAoWIXp1P+LRBEqutZdQIFUeHSa0cJRZ9LPM+GOWus8h8TlYhg==" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.plugins.animate.min.js" integrity="sha512-WxjvX/yh2SfCPUnVmZkn4MYkF/jw8GKtEjFu2+P28bcqdYYsT6feJuaaQyBw7+KWfs87Ol4jb7jB+8qep+cocg==" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.plugins.dragNodes.min.js" integrity="sha512-w9i2zoWU7Te0i+TJoKMyBjHYAptYykPieNa0iT6/ofVbUHvqIhh6f4YVkXV84kAuGbIS+CqvSV/6AHTVt8bUrA==" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.layout.noverlap.min.js" integrity="sha512-U0UOV2CPSrFlOxjSnHr6GMKsRjQIYmarSCgVp9R6FAcby2gLNPgQtGLXylELTBDLbS/R5g1vj5CFS4mLDdDfxQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.parsers.json.min.js" integrity="sha512-uhhcXJvqfQpnVqJRyCs49Ddt16zZ35qFokRiVOZei14sbMdMS9vtubrb1QQvGJ/zQhQbCttBvVJqqiZHrsHo1g==" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.layout.forceAtlas2.min.js" integrity="sha512-RuRd3WCUb6GCaiaEJ2UDkaVblIVAHJNLaDG6Df2OWpzg4kQurQqh/GC/a3eFSopnRiNrwePMFvI13pbYZ1WnAw==" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.renderers.edgeLabels.min.js" integrity="sha512-NdmXr+AEuaizDckUjMI05kDsdoXbj6Z0fDxqAqPfhecHITSzGWPA/zeE/ousxA4pVIALj0V6/JgfTGYT9aS7Jw==" crossorigin="anonymous"></script>

{% endblock %}


{% block navbar %}

	<nav class="navbar navbar-expand-lg navbar-light bg-light">
		<div class="container">

			<a class="navbar-brand" href="#">
				{% trans "OEP Stakeholder Mapper" %}
			</a>

			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTopSupportedContent">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navbarTopSupportedContent">

				<ul class="navbar-nav mr-auto">
					<li class="nav-item dropdown">
						<a class="nav-link dropdown-toggle" href="#" id="exportDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						  {% trans "Export" %}
						</a>
						<div class="dropdown-menu" aria-labelledby="exportDropdown">
							<a class="dropdown-item" href="#">
								{% trans "JSON" %}
							</a>
							<a class="dropdown-item" href="#">
								{% trans "PNG" %}
							</a>
						</div>
					</li>
					<li class="nav-item dropdown">
						<a class="nav-link dropdown-toggle" href="#" id="newDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						  {% trans "New" %}
						</a>
						<div class="dropdown-menu" aria-labelledby="newDropdown">
							<a class="dropdown-item" href="#" data-toggle="modal" data-target="#modalAddEntity">
								{% trans "Stakeholder" %}
							</a>
							<a class="dropdown-item" href="#" data-toggle="modal" data-target="#modalAddRelation">
								{% trans "Connection" %}
							</a>
							<div class="dropdown-divider"></div>
							<a class="dropdown-item" href="#" data-toggle="modal" data-target="#modalInitMap">
								{% trans "Network map" %}
							</a>
						</div>
					</li>
				</ul>

				<form class="form-inline my-2 my-lg-0">
					<input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
					<button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
				</form>

			</div>

		</div>
	</nav>

{% endblock %}


{% block content %}

<div class="container">

	<div id="canvas" class="w-100 m-4" style="height: 400px"></div>

</div>



{% endblock %}


{% block js %}

<script>

	var mapId = {{ map.id }};

    var s = new sigma({
    	renderer: {
    		container: 'canvas',
    		type: 'canvas'
    	},
		settings: {
			minNodeSize: 1,
			maxNodeSize: 10,
			minEdgeSize: 1,
			maxEdgeSize: 10,
			edgeLabelSize: 'proportional'
		}
    });

    var listener = s.configNoverlap({});
	s.startNoverlap();

    let dragListener = sigma.plugins.dragNodes(s, s.renderers[0]);

    var i = 0;

	var relation_types = {{ relation_types_flat|safe }};

	function layoutOptimize(s) {
		//Start the ForceAtlas2 algorithm to optimize network layout
		s.startForceAtlas2({worker: false, barnesHutOptimize: false, slowDown: 1000, iterationsPerRender: 1000});
		//Set time interval to allow layout algorithm to converge on a good state
		var t = 0;
		var interval = setInterval(function() {
			t += 1;
			if (t >= 5) {
				clearInterval(interval);
				s.stopForceAtlas2();
			}
		}, 100);
	}

	var nodes = {{ map.graph.nodes|safe }};
	var edges = {{ map.graph.edges|safe }};

	$.each(nodes, function(index, node) {
		s.graph.addNode({
		  id: node.id,
		  label: node.label,
		  x: node.x,
		  y: node.y,
		  size: node.size,
		  color: node.color
		})
		i = node.id;
	});

	$.each(edges, function(index, edge) {
		s.graph.addEdge({
			id: edge.id,
			source: edge.source,
			target: edge.target,
			size: edge.size,
			label: edge.label,
			color: edge.color
		})
	});

	s.refresh();

</script>

{% endblock %}